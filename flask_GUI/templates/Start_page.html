<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">

<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>

<!-- Latest compiled JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>

<style>
input[type=submit]:disabled {
  border: none;
  color: rgb(119, 111, 111);
  background-color: white;
  border: 2px solid #cad4cb;
 
}
input[type=submit] {
  padding: 25px 32px;
  background-color: white;
  color: black;
  border: 2px solid #4CAF50;
}


input[type=submit]:hover {
  background-color: #4CAF50;
  color: white;
}

input[type=button] {
  padding: 25px 32px;
  background-color: white;
  color: black;
  border: 2px solid #4CAF50;
}


input[type=button]:hover {
  background-color: #4CAF50;
  color: white;
}

</style>


<div class="row">

        <div class="header" style="text-align: center; color: green;">
        <div class="col-12">
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>
                    <br>

              <h1 style="font-family: Arial, Helvetica, sans-serif;">Welcome to Statistics-Tool </h1>
              <a href="{{wiki_page}}" target="_blank" rel="noopener noreferrer">Statistics-Tool Wiki..</a>
        </div>

                    <br>
                    <br>


</div>

    <div class="col-md-12" style="text-align: center;">
        <div>
        <input type="button" onclick="location.href='/create_new_report';" value="New Report" />
        </div>
    </div>
    
    <div class="col-md-12" style="text-align: center;margin-top: 40px;">
      <form id = "report_form" 
            action="/Reporter" 
            method="post" 
            enctype="multipart/form-data">
          
        <table class="table" style="margin: auto;width: 40% !important; "> 
          <thead>
            <tr>
              <th scope="col"></th>
              <th scope="col">Type</th>
              <th scope="col">Selected</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><b>Main</b></td>
              <td>
                <select class="form-select" aria-label="Default select example" id="report_file_type" onchange="onFileTypeChanged('report_file_type')">
                  <option value="1">Choose PKL file</option>
                  <option selected value="2">Enter reports directory path</option>
                </select>
              </td>
              <td>
                <div class="mb-3" style="margin-bottom: 0px !important;">
                  <input class="form-control" type="file" name="choose_report_file" id="choose_report_file"  onchange="onReportFileSelected()" accept="{{exp_ext}}"/>
                </div>
                <div class="form-group">
                  <input type="text" class="form-control" id="report_file_path" value="">
                </div>
              </td>
              
            </tr>
            <tr>
              <td><b>Reference</b></td>
              <td>
                <select class="form-select" aria-label="Default select example"  id="reference_file_type" onchange="onFileTypeChanged('reference_file_type')">
                  <option value="1">Choose PKL file</option>
                  <option selected value="2">Enter reports directory path</option>
                </select>
              </td>
              <td>
                <div class="mb-3" style="margin-bottom: 0px !important;">
                  <input class="form-control" type="file"  name="choose_reference_file" id="choose_reference_file" accept="{{exp_ext}}">
                </div>
                <div class="form-group">  
                  <input type="text" class="form-control" id="reference_file_path" value="">
                </div>

              </td>
            </tr>
          </tbody>
        </table>
         <div class="col-md-12" style="margin-top:20px" >
              <input type = "submit" 
                     id="submit" 
                     value = "Load Report" 
                     disabled="true" 
                     formaction="/Report_Viewer">
        </div>
        <div id="alert" class="alert alert-danger" style="margin-top:20px;">
        </div>
      </form>

       
    </div>

    <script>
      window.onload = function  () {      
        $('#choose_report_file').hide();
        $('#choose_reference_file').hide();
        
        var main_report = localStorage.getItem("main_report");
        var ref_report = localStorage.getItem("ref_report");
        
        if (main_report != null){
          $('#report_file_path').val(main_report);
          $('#submit').prop('disabled', false); 
        }
        if (ref_report != null)
          $('#reference_file_path').val(ref_report);
      } 
      
      $(document).ready(function(e){
          $("#alert").hide();

          var session = '{{ session|tojson }}';
          var json = JSON.parse(session)
          if (json.error_message != null && json.error_message != '') {
            //var msg = '{{ message}}';
            var msg = json.error_message;
            
            if (msg != ''){
              $("#alert").text(msg.toLocaleUpperCase())
              $("#alert").show();
              setTimeout(function () {
                // Closing the alert
                $('#alert').alert('close');
                $('#alert').hide();
                }, 5000);
            }
          }
          
          $('#report_form').submit(function(event) {
              
              if ($('#report_file_type').find(":selected").val() == "2"){
                var filename = $('#report_file_path').val();
                localStorage.setItem("main_report", filename);
                var inputReportFileInfo = '<input type="hidden" name=' + "'report_file_path'" + " value='" + filename + "'/>";
                $(this).append(inputReportFileInfo);
              }

              if ($('#reference_file_type').find(":selected").val() == "2"){
                var filename = $('#reference_file_path').val();
                localStorage.setItem("ref_report", filename);
                var inputReferenceFileInfo = '<input type="hidden" name=' + "'reference_file_path'" + " value='" + filename + "'/>";
                $(this).append(inputReferenceFileInfo);
              }

              return true;
          });
      });

      $("#report_file_path").on('change keydown paste input', function(){
        var filename = $('#report_file_path').val();
        if (isPKLFileName(filename)){
          $('#submit').prop('disabled', false); 
        }
        else {
          $('#submit').prop('disabled', true); 
        }
      });

      function onReportFileSelected(){
        $('#submit').prop('disabled', false); 
      }

      function isPKLFileName(filename){

        return true;

        if (String(filename).toLocaleLowerCase().endsWith("{{exp_ext}}"))
          return true;
        return false;
      }

      function onFileTypeChanged(id){
          if (id == 'report_file_type') 
          {
              if ($('#report_file_type').find(":selected").val() == "1"){
                $('#submit').prop('disabled', true); 
                $('#choose_report_file').show();
                $('#report_file_path').hide();
              } else {
                $('#choose_report_file').hide();
                $('#report_file_path').show();
                var filename = $('#report_file_path').val();
                if (isPKLFileName(filename)){
                  $('#submit').prop('disabled', false); 
                }
                else{ 
                  $('#submit').prop('disabled', true); 
                }
              }
              
          } else {
              if ($('#reference_file_type').find(":selected").val() == "1"){
                $('#choose_reference_file').show();
                $('#reference_file_path').hide();
              } else {
                $('#choose_reference_file').hide();
                $('#reference_file_path').show();
              }
          }
        }
      
  </script>
</div>
